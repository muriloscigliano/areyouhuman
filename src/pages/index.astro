---
import LandingLayout from '../layouts/LandingLayout.astro';
import GlobalStarfield from '../components/GlobalStarfield.vue';
import AreYouHuman from '../components/AreYouHuman.vue';
import HeroSection from '../components/HeroSection.vue';
import StatementSection from '../components/StatementSection.astro';
import WhatWeDoSections from '../components/WhatWeDoSections.vue';
import FrameworkAuditSection from '../components/FrameworkAuditSection.astro';
import WhatWeBuildSection from '../components/WhatWeBuildSection.astro';
import FooterSection from '../components/FooterSection.astro';
import '../styles/global.css';
---

<LandingLayout>
  <!-- Global Starfield - persists across intro and hero, never resets -->
  <div id="starfield-container">
    <GlobalStarfield client:load />
  </div>

  <AreYouHuman client:load />

  <main class="landing landing--hidden" id="main-content">
    <!-- Hero wrapper for sticky effect -->
    <div class="hero-sticky-wrapper">
      <HeroSection client:load />
    </div>

    <!-- Content that scrolls over the hero -->
    <div class="content-over-hero">
      <StatementSection />

    <WhatWeDoSections client:load />
    
    <FrameworkAuditSection />

    <WhatWeBuildSection />

    <FooterSection />
    </div>
  </main>
</LandingLayout>

<script>
  // Detect if this is a page refresh vs navigation from inner page
  // On refresh: clear introCompleted so intro plays again
  // On navigation from inner page: introCompleted is already set by PageTransition
  const navEntries = performance.getEntriesByType('navigation');
  const isRefresh = navEntries.length > 0 &&
    (navEntries[0] as PerformanceNavigationTiming).type === 'reload';

  if (isRefresh) {
    sessionStorage.removeItem('introCompleted');
  }

  // Check if intro was completed (set by PageTransition when navigating back to home)
  const introCompleted = sessionStorage.getItem('introCompleted') === 'true';

  if (introCompleted) {
    // Show content immediately without waiting for DOMContentLoaded
    document.addEventListener('DOMContentLoaded', () => {
      const mainContent = document.getElementById('main-content');
      if (mainContent) {
        mainContent.classList.remove('landing--hidden');
      }
    });
  }

  // Also listen for intro-complete event (for first-time visitors)
  window.addEventListener('intro-complete', () => {
    const mainContent = document.getElementById('main-content');
    if (mainContent) {
      mainContent.classList.remove('landing--hidden');
    }
  });
</script>

<style>
  #starfield-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 0;
    pointer-events: none;
  }

  .landing {
    min-height: 100vh;
    opacity: 1;
    transition: opacity 0.5s ease;
    position: relative;
    z-index: 2;
    background: transparent;
  }

  .landing--hidden {
    opacity: 0;
    pointer-events: none;
  }

  /* Hero sticky wrapper - hero stays fixed while content scrolls over */
  .hero-sticky-wrapper {
    position: sticky;
    top: 0;
    height: 100vh;
    z-index: 1;
  }

  /* Content that scrolls over the hero */
  .content-over-hero {
    position: relative;
    z-index: 2;
    background: #fff;
    overflow: visible;
  }

  /* All sections after hero have solid black background */
  .content-over-hero > * {
    background: #000;
    overflow: visible;
  }
</style>
