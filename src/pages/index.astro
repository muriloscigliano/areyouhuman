---
import LandingLayout from '../layouts/LandingLayout.astro';
import GlobalStarfield from '../components/GlobalStarfield.vue';
import AreYouHuman from '../components/AreYouHuman.vue';
import HeroSection from '../components/HeroSection.vue';
import StatementSection from '../components/StatementSection.astro';
import WhatWeDoSections from '../components/WhatWeDoSections.vue';
import FrameworkAuditSection from '../components/FrameworkAuditSection.astro';
import WhatWeBuildSection from '../components/WhatWeBuildSection.astro';
import FooterSection from '../components/FooterSection.astro';
import '../styles/global.css';
---

<LandingLayout>
  <!-- Global Starfield - persists across intro and hero, never resets -->
  <div id="starfield-container">
    <GlobalStarfield client:load />
  </div>

  <AreYouHuman client:load />

  <main class="landing landing--hidden" id="main-content">
    <!-- Hero wrapper for sticky effect -->
    <div class="hero-sticky-wrapper">
      <HeroSection client:load />
    </div>

    <!-- Content that scrolls over the hero -->
    <div class="content-over-hero">
      <StatementSection />

    <WhatWeDoSections client:load />
    
    <FrameworkAuditSection />

    <WhatWeBuildSection />

    <FooterSection />
    </div>
  </main>
</LandingLayout>

<script>
  // Clear intro state on fresh page load to home - intro should always play on refresh
  // Use performance.navigation or PerformanceNavigationTiming to detect refresh/direct navigation
  const isDirectNavigation = (() => {
    // Check if this is a fresh page load (refresh, direct URL, or new tab)
    const navEntries = performance.getEntriesByType('navigation');
    if (navEntries.length > 0) {
      const navType = (navEntries[0] as PerformanceNavigationTiming).type;
      // 'reload' = refresh, 'navigate' = direct URL or link click
      // 'back_forward' = browser back/forward button
      return navType === 'reload' || navType === 'navigate';
    }
    // Fallback for older browsers
    return performance.navigation?.type === 0 || performance.navigation?.type === 1;
  })();

  // If this is a direct navigation to home (refresh or new tab), reset intro state
  if (isDirectNavigation) {
    sessionStorage.removeItem('introCompleted');
  }

  // Check if intro was completed (only true if navigating back from inner page)
  const introCompleted = sessionStorage.getItem('introCompleted') === 'true';

  if (introCompleted) {
    // Show content immediately without waiting for DOMContentLoaded
    document.addEventListener('DOMContentLoaded', () => {
      const mainContent = document.getElementById('main-content');
      if (mainContent) {
        mainContent.classList.remove('landing--hidden');
      }
    });
  }

  // Also listen for intro-complete event (for first-time visitors)
  window.addEventListener('intro-complete', () => {
    const mainContent = document.getElementById('main-content');
    if (mainContent) {
      mainContent.classList.remove('landing--hidden');
    }
  });
</script>

<style>
  #starfield-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 0;
    pointer-events: none;
  }

  .landing {
    min-height: 100vh;
    opacity: 1;
    transition: opacity 0.5s ease;
    position: relative;
    z-index: 2;
    background: transparent;
  }

  .landing--hidden {
    opacity: 0;
    pointer-events: none;
  }

  /* Hero sticky wrapper - hero stays fixed while content scrolls over */
  .hero-sticky-wrapper {
    position: sticky;
    top: 0;
    height: 100vh;
    z-index: 1;
  }

  /* Content that scrolls over the hero */
  .content-over-hero {
    position: relative;
    z-index: 2;
    background: #fff;
    overflow: visible;
  }

  /* All sections after hero have solid black background */
  .content-over-hero > * {
    background: #000;
    overflow: visible;
  }
</style>
